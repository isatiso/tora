{"code":"import { FM_DI_TOKEN } from '../token';\r\nexport class ClassProvider {\r\n    constructor(cls, injector, multi) {\r\n        var _a;\r\n        this.cls = cls;\r\n        this.injector = injector;\r\n        this.multi = multi;\r\n        this.used = false;\r\n        this.name = cls.name;\r\n        this.multi = (_a = this.multi) !== null && _a !== void 0 ? _a : false;\r\n    }\r\n    get_param_instance(parents) {\r\n        var _a;\r\n        const provider_list = this.extract_param_types(parents);\r\n        const param_list = (_a = provider_list === null || provider_list === void 0 ? void 0 : provider_list.map((provider) => {\r\n            return provider === null || provider === void 0 ? void 0 : provider.create(parents);\r\n        })) !== null && _a !== void 0 ? _a : [];\r\n        return new this.cls(...param_list);\r\n    }\r\n    set_param_instance_used(parents) {\r\n        var _a;\r\n        (_a = this.extract_param_types(parents)) === null || _a === void 0 ? void 0 : _a.forEach((provider) => provider === null || provider === void 0 ? void 0 : provider.set_used(parents));\r\n    }\r\n    create(parents) {\r\n        var _a, _b;\r\n        const exist = (_a = parents === null || parents === void 0 ? void 0 : parents.indexOf(this.cls)) !== null && _a !== void 0 ? _a : -1;\r\n        if (exist >= 0) {\r\n            const circle_path = (_b = parents === null || parents === void 0 ? void 0 : parents.slice(exist)) !== null && _b !== void 0 ? _b : [];\r\n            circle_path.push(this.cls);\r\n            throw new Error('circle dependency: ' + circle_path.map(cls => cls.name).join(' => '));\r\n        }\r\n        parents = (parents !== null && parents !== void 0 ? parents : []).concat(this.cls);\r\n        this.used = true;\r\n        if (this.multi) {\r\n            return this.get_param_instance(parents);\r\n        }\r\n        if (!this.resolved) {\r\n            this.resolved = this.get_param_instance(parents);\r\n        }\r\n        return this.resolved;\r\n    }\r\n    extract_param_types(parents) {\r\n        var _a;\r\n        const inject_token_map = Reflect.getMetadata(FM_DI_TOKEN.param_injection, this.cls);\r\n        return (_a = Reflect.getMetadata('design:paramtypes', this.cls)) === null || _a === void 0 ? void 0 : _a.map((token, i) => {\r\n            var _a, _b;\r\n            const inject_token = inject_token_map === null || inject_token_map === void 0 ? void 0 : inject_token_map[i];\r\n            if (inject_token) {\r\n                token = inject_token;\r\n            }\r\n            if (token === undefined) {\r\n                throw new Error(`type 'undefined' at ${(_a = this.cls) === null || _a === void 0 ? void 0 : _a.name}.constructor[${i}], if it's not specified, there maybe a circular import.`);\r\n            }\r\n            const provider = this.injector.get(token, `${parents === null || parents === void 0 ? void 0 : parents.map(p => p.name).join(' -> ')}`);\r\n            if (provider) {\r\n                return provider;\r\n            }\r\n            throw new Error(`Can't find provider of \"${token}\" in [${(_b = this.cls) === null || _b === void 0 ? void 0 : _b.name}, constructor, args[${i}]]`);\r\n        });\r\n    }\r\n    set_used(parents) {\r\n        parents = (parents !== null && parents !== void 0 ? parents : []).concat(this.cls);\r\n        this.used = true;\r\n        this.set_param_instance_used(parents);\r\n    }\r\n}\r\nexport class ValueProvider {\r\n    constructor(name, value) {\r\n        this.name = name;\r\n        this.value = value;\r\n        this.used = false;\r\n    }\r\n    create() {\r\n        this.used = true;\r\n        return this.value;\r\n    }\r\n    set_used() {\r\n        this.used = true;\r\n    }\r\n}\r\nexport class FactoryProvider {\r\n    constructor(name, factory, deps) {\r\n        this.name = name;\r\n        this.factory = factory;\r\n        this.deps = deps;\r\n        this.used = false;\r\n    }\r\n    create() {\r\n        var _a;\r\n        this.used = true;\r\n        return this.factory(...((_a = this.deps) !== null && _a !== void 0 ? _a : []));\r\n    }\r\n    set_used() {\r\n        this.used = true;\r\n    }\r\n}\r\nexport function def2Provider(defs, injector) {\r\n    return defs === null || defs === void 0 ? void 0 : defs.map(def => {\r\n        if (def.useValue) {\r\n            const d = def;\r\n            return [d.provide, new ValueProvider('valueProvider', d.useValue)];\r\n        }\r\n        else if (def.useFactory) {\r\n            const d = def;\r\n            return [d.provide, new FactoryProvider('FactoryProvider', d.useFactory, d.deps),];\r\n        }\r\n        else if (def.useClass) {\r\n            const d = def;\r\n            const isComponent = Reflect.getMetadata(FM_DI_TOKEN.component, d.useClass);\r\n            if (!isComponent) {\r\n                throw new Error(`${d.useClass.name} is not Component.`);\r\n            }\r\n            return [d.provide, new ClassProvider(d.useClass, injector, d.multi)];\r\n        }\r\n        else {\r\n            const isComponent = Reflect.getMetadata(FM_DI_TOKEN.component, def);\r\n            if (!isComponent) {\r\n                throw new Error(`${def.name} is not Component.`);\r\n            }\r\n            return [def, new ClassProvider(def, injector)];\r\n        }\r\n    });\r\n}\r\n//# sourceMappingURL=provider.js.map","references":["/Users/caojiahang/代码/tora/src/token.ts","/Users/caojiahang/代码/tora/src/type.ts","/Users/caojiahang/代码/tora/src/di/injector.ts"],"map":"{\"version\":3,\"file\":\"provider.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/di/provider.ts\"],\"names\":[],\"mappings\":\"AAAA,OAAO,EAAE,WAAW,EAAE,MAAM,UAAU,CAAA;AAYtC,MAAM,OAAO,aAAa;IAMtB,YACY,GAAY,EACb,QAAkB,EACR,KAAe;;QAFxB,QAAG,GAAH,GAAG,CAAS;QACb,aAAQ,GAAR,QAAQ,CAAU;QACR,UAAK,GAAL,KAAK,CAAU;QAL7B,SAAI,GAAG,KAAK,CAAA;QAOf,IAAI,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,CAAA;QACpB,IAAI,CAAC,KAAK,SAAG,IAAI,CAAC,KAAK,mCAAI,KAAK,CAAA;IACpC,CAAC;IAEO,kBAAkB,CAAC,OAAe;;QACtC,MAAM,aAAa,GAAG,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,CAAA;QACvD,MAAM,UAAU,SAAG,aAAa,aAAb,aAAa,uBAAb,aAAa,CAAE,GAAG,CAAC,CAAC,QAAa,EAAE,EAAE;YACpD,OAAO,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,MAAM,CAAC,OAAO,EAAC;QACpC,CAAC,oCAAK,EAAE,CAAA;QACR,OAAO,IAAI,IAAI,CAAC,GAAG,CAAC,GAAG,UAAU,CAAC,CAAA;IACtC,CAAC;IAEO,uBAAuB,CAAC,OAAe;;QAC3C,MAAA,IAAI,CAAC,mBAAmB,CAAC,OAAO,CAAC,0CAAE,OAAO,CAAC,CAAC,QAAuB,EAAE,EAAE,CAAC,QAAQ,aAAR,QAAQ,uBAAR,QAAQ,CAAE,QAAQ,CAAC,OAAO,CAAC,EAAC;IACxG,CAAC;IAED,MAAM,CAAC,OAAe;;QAClB,MAAM,KAAK,SAAG,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,OAAO,CAAC,IAAI,CAAC,GAAG,oCAAK,CAAC,CAAC,CAAA;QAC9C,IAAI,KAAK,IAAI,CAAC,EAAE;YACZ,MAAM,WAAW,SAAG,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,KAAK,CAAC,KAAK,oCAAK,EAAE,CAAA;YAC/C,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;YAC1B,MAAM,IAAI,KAAK,CAAC,qBAAqB,GAAG,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAA;SACzF;QACD,OAAO,GAAG,CAAC,OAAO,aAAP,OAAO,cAAP,OAAO,GAAI,EAAE,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;QAC1C,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,IAAI,IAAI,CAAC,KAAK,EAAE;YACZ,OAAO,IAAI,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAA;SAC1C;QACD,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE;YAChB,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,kBAAkB,CAAC,OAAO,CAAC,CAAA;SACnD;QACD,OAAO,IAAI,CAAC,QAAQ,CAAA;IACxB,CAAC;IAEO,mBAAmB,CAAC,OAAe;;QACvC,MAAM,gBAAgB,GAAG,OAAO,CAAC,WAAW,CAAC,WAAW,CAAC,eAAe,EAAE,IAAI,CAAC,GAAG,CAAC,CAAA;QACnF,aAAO,OAAO,CAAC,WAAW,CAAC,mBAAmB,EAAE,IAAI,CAAC,GAAG,CAAC,0CAAE,GAAG,CAAC,CAAC,KAAU,EAAE,CAAS,EAAE,EAAE;;YACrF,MAAM,YAAY,GAAG,gBAAgB,aAAhB,gBAAgB,uBAAhB,gBAAgB,CAAG,CAAC,CAAC,CAAA;YAC1C,IAAI,YAAY,EAAE;gBACd,KAAK,GAAG,YAAY,CAAA;aACvB;YACD,IAAI,KAAK,KAAK,SAAS,EAAE;gBACrB,MAAM,IAAI,KAAK,CAAC,uBAAuB,MAAA,IAAI,CAAC,GAAG,0CAAE,IAAI,gBAAgB,CAAC,0DAA0D,CAAC,CAAA;aACpI;YACD,MAAM,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,KAAK,EAAE,GAAG,OAAO,aAAP,OAAO,uBAAP,OAAO,CAAE,GAAG,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,CAAA;YACtF,IAAI,QAAQ,EAAE;gBACV,OAAO,QAAQ,CAAA;aAClB;YACD,MAAM,IAAI,KAAK,CAAC,2BAA2B,KAAK,SAAS,MAAA,IAAI,CAAC,GAAG,0CAAE,IAAI,uBAAuB,CAAC,IAAI,CAAC,CAAA;QACxG,CAAC,EAAC;IACN,CAAC;IAED,QAAQ,CAAC,OAAe;QACpB,OAAO,GAAG,CAAC,OAAO,aAAP,OAAO,cAAP,OAAO,GAAI,EAAE,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;QAC1C,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,IAAI,CAAC,uBAAuB,CAAC,OAAO,CAAC,CAAA;IACzC,CAAC;CACJ;AAED,MAAM,OAAO,aAAa;IAItB,YACW,IAAY,EACF,KAAQ;QADlB,SAAI,GAAJ,IAAI,CAAQ;QACF,UAAK,GAAL,KAAK,CAAG;QAJtB,SAAI,GAAG,KAAK,CAAA;IAMnB,CAAC;IAED,MAAM;QACF,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,OAAO,IAAI,CAAC,KAAK,CAAA;IACrB,CAAC;IAED,QAAQ;QACJ,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;IACpB,CAAC;CACJ;AAED,MAAM,OAAO,eAAe;IAIxB,YACW,IAAY,EACX,OAA8B,EAC9B,IAAY;QAFb,SAAI,GAAJ,IAAI,CAAQ;QACX,YAAO,GAAP,OAAO,CAAuB;QAC9B,SAAI,GAAJ,IAAI,CAAQ;QALjB,SAAI,GAAG,KAAK,CAAA;IAOnB,CAAC;IAED,MAAM;;QACF,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;QAChB,OAAO,IAAI,CAAC,OAAO,CAAC,GAAG,OAAC,IAAI,CAAC,IAAI,mCAAI,EAAE,CAAC,CAAC,CAAA;IAC7C,CAAC;IAED,QAAQ;QACJ,IAAI,CAAC,IAAI,GAAG,IAAI,CAAA;IACpB,CAAC;CACJ;AAED,MAAM,UAAU,YAAY,CAAC,IAAiC,EAAE,QAAkB;IAC9E,OAAO,IAAI,aAAJ,IAAI,uBAAJ,IAAI,CAAE,GAAG,CAAC,GAAG,CAAC,EAAE;QACnB,IAAK,GAAW,CAAC,QAAQ,EAAE;YAEvB,MAAM,CAAC,GAAG,GAAuB,CAAA;YACjC,OAAO,CAAC,CAAC,CAAC,OAAO,EAAE,IAAI,aAAa,CAAC,eAAe,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAA;SAErE;aAAM,IAAK,GAAW,CAAC,UAAU,EAAE;YAEhC,MAAM,CAAC,GAAG,GAAyB,CAAA;YACnC,OAAO,CAAC,CAAC,CAAC,OAAO,EAAE,IAAI,eAAe,CAAC,iBAAiB,EAAE,CAAC,CAAC,UAAiB,EAAE,CAAC,CAAC,IAAI,CAAC,EAAE,CAAA;SAE3F;aAAM,IAAK,GAAW,CAAC,QAAQ,EAAE;YAE9B,MAAM,CAAC,GAAG,GAAuB,CAAA;YACjC,MAAM,WAAW,GAAG,OAAO,CAAC,WAAW,CAAC,WAAW,CAAC,SAAS,EAAE,CAAC,CAAC,QAAQ,CAAC,CAAA;YAC1E,IAAI,CAAC,WAAW,EAAE;gBACd,MAAM,IAAI,KAAK,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC,IAAI,oBAAoB,CAAC,CAAA;aAC1D;YACD,OAAO,CAAC,CAAC,CAAC,OAAO,EAAE,IAAI,aAAa,CAAM,CAAC,CAAC,QAAQ,EAAE,QAAQ,EAAE,CAAC,CAAC,KAAK,CAAC,CAAC,CAAA;SAE5E;aAAM;YAEH,MAAM,WAAW,GAAG,OAAO,CAAC,WAAW,CAAC,WAAW,CAAC,SAAS,EAAE,GAAU,CAAC,CAAA;YAC1E,IAAI,CAAC,WAAW,EAAE;gBACd,MAAM,IAAI,KAAK,CAAC,GAAI,GAAW,CAAC,IAAI,oBAAoB,CAAC,CAAA;aAC5D;YACD,OAAO,CAAC,GAAG,EAAE,IAAI,aAAa,CAAM,GAAU,EAAE,QAAQ,CAAC,CAAC,CAAA;SAC7D;IACL,CAAC,EAAC;AACN,CAAC\"}"}
