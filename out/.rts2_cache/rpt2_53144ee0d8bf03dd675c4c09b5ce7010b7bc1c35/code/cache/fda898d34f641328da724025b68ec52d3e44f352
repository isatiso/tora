{"code":"import { AnnotationTools, ClassProvider } from './di';\r\nimport { FM_DI_TOKEN, TokenUtils } from './token';\r\nfunction join_path(front, rear) {\r\n    return (front + '/' + rear).replace(/^\\//, '').replace(/\\/$/, '');\r\n}\r\nexport function Router(path, options) {\r\n    return function (target) {\r\n        TokenUtils.setClassType(target, 'fm_router');\r\n        Reflect.defineMetadata(FM_DI_TOKEN.router_handler_collector, makeRouterCollector(target, path, options), target);\r\n        Reflect.defineMetadata(FM_DI_TOKEN.router_options, options, target);\r\n    };\r\n}\r\nfunction createRequestDecorator(method) {\r\n    return (router_path) => (target, key, desc) => {\r\n        var _a, _b, _c;\r\n        const handler = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.request_handler, target, key, {});\r\n        if (!handler.methods) {\r\n            handler.methods = new Set();\r\n        }\r\n        handler.methods.add(method);\r\n        handler.path = (_b = (_a = handler.path) !== null && _a !== void 0 ? _a : router_path) !== null && _b !== void 0 ? _b : key;\r\n        handler.wrap_result = true;\r\n        handler.pos = `${target.name}.${key}`;\r\n        if (!handler.handler) {\r\n            handler.handler = desc.value;\r\n        }\r\n        if (!handler.param_types) {\r\n            const inject_token_map = Reflect.getMetadata(FM_DI_TOKEN.param_injection, target, key);\r\n            handler.param_types = (_c = Reflect.getMetadata('design:paramtypes', target, key)) === null || _c === void 0 ? void 0 : _c.map((t, i) => { var _a; return (_a = inject_token_map === null || inject_token_map === void 0 ? void 0 : inject_token_map[i]) !== null && _a !== void 0 ? _a : t; });\r\n        }\r\n        const handlers = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.router_handlers, target, undefined, []);\r\n        if (!handlers.includes(handler)) {\r\n            handlers.push(handler);\r\n        }\r\n    };\r\n}\r\nexport const Get = createRequestDecorator('GET');\r\nexport const Post = createRequestDecorator('POST');\r\nexport const Put = createRequestDecorator('PUT');\r\nexport const Delete = createRequestDecorator('DELETE');\r\nexport function Auth(auth_target = 'admin') {\r\n    return (target, key) => {\r\n        const handler = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.request_handler, target, key, {});\r\n        handler.auth = auth_target;\r\n    };\r\n}\r\nexport function NoWrap() {\r\n    return (target, key) => {\r\n        const handler = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.request_handler, target, key, {});\r\n        handler.wrap_result = false;\r\n    };\r\n}\r\nexport function CacheWith(prefix, expires) {\r\n    return (target, key) => {\r\n        const handler = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.request_handler, target, key, {});\r\n        handler.cache_prefix = prefix;\r\n        handler.cache_expires = expires;\r\n    };\r\n}\r\nexport function Disabled() {\r\n    return (target, key) => {\r\n        const handler = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.request_handler, target, key, {});\r\n        handler.disabled = true;\r\n    };\r\n}\r\nfunction makeRouterCollector(target, path, options) {\r\n    return function (injector) {\r\n        var _a;\r\n        const instance = new ClassProvider(target, injector).create();\r\n        Reflect.defineMetadata(FM_DI_TOKEN.instance, instance, target);\r\n        const handlers = AnnotationTools.get_set_meta_data(FM_DI_TOKEN.router_handlers, target.prototype, undefined, []);\r\n        handlers === null || handlers === void 0 ? void 0 : handlers.forEach((item) => Object.assign(item, {\r\n            path: join_path(path, item.path),\r\n            handler: item.handler.bind(instance)\r\n        }));\r\n        (_a = options === null || options === void 0 ? void 0 : options.children) === null || _a === void 0 ? void 0 : _a.forEach(r => {\r\n            var _a, _b;\r\n            (_b = (_a = Reflect.getMetadata(FM_DI_TOKEN.router_handler_collector, r)) === null || _a === void 0 ? void 0 : _a(injector)) === null || _b === void 0 ? void 0 : _b.forEach((sr) => {\r\n                sr.path = join_path(path, sr.path);\r\n                handlers.push(sr);\r\n            });\r\n        });\r\n        return handlers;\r\n    };\r\n}\r\n//# sourceMappingURL=fm-router.js.map","references":["/Users/caojiahang/代码/tora/src/di/index.ts","/Users/caojiahang/代码/tora/src/server/index.ts","/Users/caojiahang/代码/tora/src/token.ts","/Users/caojiahang/代码/tora/src/type.ts"],"map":"{\"version\":3,\"file\":\"fm-router.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../src/fm-router.ts\"],\"names\":[],\"mappings\":\"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\"}"}
