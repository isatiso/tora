{"code":"import { __awaiter } from \"tslib\";\r\nimport { FinishProcess, LocalFinishProcess, throw_fm_panic } from '../error';\r\nexport class SessionContext {\r\n    constructor(ctx, auth, cache, cache_prefix, cache_expires) {\r\n        var _a, _b;\r\n        this.ctx = ctx;\r\n        this.auth = auth;\r\n        this.cache = cache;\r\n        (_a = this.auth) === null || _a === void 0 ? void 0 : _a.load_token(ctx);\r\n        (_b = this.cache) === null || _b === void 0 ? void 0 : _b.set_cache_options({\r\n            cache_prefix: cache_prefix !== null && cache_prefix !== void 0 ? cache_prefix : this.ctx.path,\r\n            cache_expires: cache_expires !== null && cache_expires !== void 0 ? cache_expires : 3600\r\n        });\r\n    }\r\n    get url() {\r\n        return this.ctx.req.url;\r\n    }\r\n    get method() {\r\n        return this.ctx.req.method;\r\n    }\r\n    get path() {\r\n        return this.ctx.path;\r\n    }\r\n    get real_ip() {\r\n        return this.ctx.request.get('X-Real-IP');\r\n    }\r\n    get rawBody() {\r\n        return this.ctx.request.rawBody;\r\n    }\r\n    get query() {\r\n        return this.ctx.query;\r\n    }\r\n    get user() {\r\n        var _a, _b;\r\n        return (_b = (_a = this.auth) === null || _a === void 0 ? void 0 : _a.get_user_info()) !== null && _b !== void 0 ? _b : throw_fm_panic(401, 'Unauthorized.');\r\n    }\r\n    get maybe_user() {\r\n        var _a;\r\n        return (_a = this.auth) === null || _a === void 0 ? void 0 : _a.get_user_info();\r\n    }\r\n    header(key) {\r\n        return this.ctx.request.headers[key.toLowerCase()];\r\n    }\r\n    headers() {\r\n        return this.ctx.request.headers;\r\n    }\r\n    response_header(key, value) {\r\n        this.ctx.response.set(key.toLowerCase(), value + '');\r\n    }\r\n    do_auth() {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            return yield ((_a = this.auth) === null || _a === void 0 ? void 0 : _a.auth());\r\n        });\r\n    }\r\n    redirect(url, alt) {\r\n        this.ctx.redirect(url, alt);\r\n        throw new FinishProcess(this.ctx, '');\r\n    }\r\n    finish(data) {\r\n        throw new LocalFinishProcess(data);\r\n    }\r\n    clear_cache(key) {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            return (_a = this.cache) === null || _a === void 0 ? void 0 : _a.clear(key);\r\n        });\r\n    }\r\n    return_if_cache(key) {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const cache = key && (yield ((_a = this.cache) === null || _a === void 0 ? void 0 : _a.get(key)));\r\n            if (cache) {\r\n                this.finish(cache);\r\n            }\r\n            return null;\r\n        });\r\n    }\r\n    finish_and_cache(info_promise, also_return) {\r\n        var _a;\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            const info = yield info_promise;\r\n            yield ((_a = this.cache) === null || _a === void 0 ? void 0 : _a.set(info));\r\n            if (also_return) {\r\n                this.finish(info);\r\n            }\r\n            return Promise.resolve(info);\r\n        });\r\n    }\r\n}\r\n//# sourceMappingURL=context.js.map","references":["/Users/caojiahang/代码/tora/src/error.ts","/Users/caojiahang/代码/tora/src/server/authenticator.ts","/Users/caojiahang/代码/tora/src/server/cache-proxy.ts","/Users/caojiahang/代码/tora/src/server/types.ts"],"map":"{\"version\":3,\"file\":\"context.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/server/context.ts\"],\"names\":[],\"mappings\":\"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\"}"}
