{"code":"import { __awaiter } from \"tslib\";\r\nimport parse from 'co-body';\r\nimport Koa from 'koa';\r\nexport class FmKoa {\r\n    constructor(options) {\r\n        this._koa = new Koa();\r\n        this._body_parser = new BodyParser();\r\n        this.body_parser = (ctx, next) => __awaiter(this, void 0, void 0, function* () {\r\n            if (ctx.request.body !== undefined || ctx.disableBodyParser) {\r\n                return yield next();\r\n            }\r\n            try {\r\n                const res = yield this._body_parser.parseBody(ctx);\r\n                ctx.request.body = 'parsed' in res ? res.parsed : {};\r\n                if (ctx.request.rawBody === undefined) {\r\n                    ctx.request.rawBody = res.raw;\r\n                }\r\n            }\r\n            catch (err) {\r\n                ctx.response.status = 400;\r\n                ctx.response.body = 'Bad Request';\r\n                console.log('parse body error', ctx.request.path);\r\n            }\r\n            return yield next();\r\n        });\r\n        this.cors = (ctx, next) => __awaiter(this, void 0, void 0, function* () {\r\n            ctx.response.res.setHeader('Access-Control-Allow-Origin', '*');\r\n            if (ctx.method === 'OPTIONS') {\r\n                ctx.response.res.setHeader('Access-Control-Allow-Headers', 'Access-Control-Allow-Origin,origin,Content-Type,Accept,Authorization');\r\n                ctx.response.res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS');\r\n                ctx.response.body = '';\r\n            }\r\n            return yield next();\r\n        });\r\n        if (options.cors) {\r\n            this._koa.use(this.cors);\r\n        }\r\n        if (options.body_parser) {\r\n            this._koa.use(this.body_parser);\r\n        }\r\n    }\r\n    use(middleware) {\r\n        this._koa.use(middleware);\r\n    }\r\n    handle_by(server) {\r\n        this._koa.use((ctx, next) => __awaiter(this, void 0, void 0, function* () { return server.handleRequest(ctx, next); }));\r\n        return this;\r\n    }\r\n    listen(port, cb) {\r\n        this._koa.on('error', (err, ctx) => {\r\n            if (err.code !== 'HPE_INVALID_EOF_STATE') {\r\n                console.log('server error', err, ctx);\r\n                console.log(ctx.request.rawBody);\r\n            }\r\n        }).listen(port, cb);\r\n    }\r\n}\r\nexport class BodyParser {\r\n    constructor(options) {\r\n        this.jsonTypes = ['application/json', 'application/json-patch+json', 'application/vnd.api+json', 'application/csp-report'];\r\n        this.formTypes = ['application/x-www-form-urlencoded'];\r\n        this.textTypes = ['text/plain', 'text/xml', 'application/xml', 'text/html'];\r\n        this.opts = Object.assign({ returnRawBody: true }, options);\r\n        const enableTypes = this.opts.enableTypes || ['json', 'form', 'text'];\r\n        this.enableForm = enableTypes === null || enableTypes === void 0 ? void 0 : enableTypes.includes('form');\r\n        this.enableJson = enableTypes === null || enableTypes === void 0 ? void 0 : enableTypes.includes('json');\r\n        this.enableText = enableTypes === null || enableTypes === void 0 ? void 0 : enableTypes.includes('text');\r\n    }\r\n    parseBody(ctx) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            if (this.enableJson && ctx.request.is(this.jsonTypes)) {\r\n                return parse.json(ctx, this.opts);\r\n            }\r\n            else if (this.enableForm && ctx.request.is(this.formTypes)) {\r\n                return parse.form(ctx, this.opts);\r\n            }\r\n            else if (this.enableText && ctx.request.is(this.textTypes)) {\r\n                return parse.text(ctx, this.opts).then((v) => v || '');\r\n            }\r\n            else {\r\n                return {};\r\n            }\r\n        });\r\n    }\r\n}\r\n//# sourceMappingURL=fm-koa.js.map","references":["/Users/caojiahang/代码/tora/node_modules/@types/co-body/index.d.ts","/Users/caojiahang/代码/tora/node_modules/@types/koa/index.d.ts","/Users/caojiahang/代码/tora/src/server/index.ts","/Users/caojiahang/代码/tora/node_modules/@types/koa/index.d.ts"],"map":"{\"version\":3,\"file\":\"fm-koa.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../src/fm-koa.ts\"],\"names\":[],\"mappings\":\"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\"}"}
