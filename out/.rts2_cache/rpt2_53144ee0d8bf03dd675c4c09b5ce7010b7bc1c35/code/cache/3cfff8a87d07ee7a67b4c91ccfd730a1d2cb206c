{"code":"import { throw_fm_panic } from '../error';\r\nexport const PURE_PARAMS = 'PURE_PARAMS';\r\nclass Reference {\r\n    constructor(data) {\r\n        this.data = data;\r\n    }\r\n    get(prop, def) {\r\n        var _a;\r\n        return (_a = this.data[prop]) !== null && _a !== void 0 ? _a : def;\r\n    }\r\n}\r\nexport class Judgement extends Reference {\r\n    testValue(value, type) {\r\n        if (type instanceof RegExp) {\r\n            return typeof value === 'string' && type.test(value);\r\n        }\r\n        switch (type) {\r\n            case 'exist':\r\n                return value !== undefined;\r\n            case 'true':\r\n                return Boolean(value);\r\n            case 'false':\r\n                return !Boolean(value);\r\n            case 'boolean':\r\n                return typeof value === 'boolean';\r\n            case 'object':\r\n                return Object.prototype.toString.call(value) === '[object Object]';\r\n            case 'function':\r\n                return Object.prototype.toString.call(value) === '[object Function]';\r\n            case 'array':\r\n                return Array.isArray(value);\r\n            case 'nonEmptyArray':\r\n                return Array.isArray(value) && value.length;\r\n            case 'string':\r\n                return typeof value === 'string';\r\n            case 'nonEmptyString':\r\n                return typeof value === 'string' && value;\r\n            case 'number':\r\n                return typeof value === 'number';\r\n            case 'nonZeroNumber':\r\n                return typeof value === 'number' && value;\r\n            case 'null':\r\n                return value === null;\r\n            case 'nonNull':\r\n                return value !== null;\r\n            default:\r\n                return value !== undefined;\r\n        }\r\n    }\r\n    any(value, types) {\r\n        for (const type of types) {\r\n            if (this.testValue(value, type)) {\r\n                return true;\r\n            }\r\n        }\r\n        return false;\r\n    }\r\n    all(value, types) {\r\n        for (const type of types) {\r\n            if (!this.testValue(value, type)) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n}\r\nexport class ApiParams extends Judgement {\r\n    getIf(prop, match, def) {\r\n        const res = super.get(prop);\r\n        if (res !== undefined && this.testValue(res, match)) {\r\n            return res;\r\n        }\r\n        return def;\r\n    }\r\n    getIfAny(prop, match, def) {\r\n        const res = super.get(prop);\r\n        if (res !== undefined && this.any(res, match)) {\r\n            return res;\r\n        }\r\n        return def;\r\n    }\r\n    getIfAll(prop, match, def) {\r\n        const res = super.get(prop);\r\n        if (res !== undefined && this.all(res, match)) {\r\n            return res;\r\n        }\r\n        return def;\r\n    }\r\n    ensureAny(prop, match) {\r\n        const res = super.get(prop);\r\n        if (res === undefined) {\r\n            throw_fm_panic(400, `Can not find ${prop}`);\r\n        }\r\n        if (this.any(res, match)) {\r\n            return res;\r\n        }\r\n        throw_fm_panic(400, `prop \"${prop}\" is illegal.`);\r\n    }\r\n    ensureAll(prop, match) {\r\n        const res = super.get(prop);\r\n        if (res === undefined) {\r\n            throw_fm_panic(400, `Can not find ${prop}`);\r\n        }\r\n        if (this.all(res, match)) {\r\n            return res;\r\n        }\r\n        throw_fm_panic(400, `prop \"${prop}\" is illegal.`);\r\n    }\r\n    ensure(prop, match) {\r\n        match = match || 'exist';\r\n        const res = super.get(prop);\r\n        if (res === undefined) {\r\n            throw_fm_panic(400, `Can not find ${prop}`);\r\n        }\r\n        if (this.testValue(res, match)) {\r\n            return res;\r\n        }\r\n        throw_fm_panic(400, `prop \"${prop}\" is illegal.`);\r\n    }\r\n    diveDeepOrUndefined(prop) {\r\n        const res = super.get(prop);\r\n        if (res !== undefined && this.testValue(res, 'object')) {\r\n            return new ApiParams(res);\r\n        }\r\n        return undefined;\r\n    }\r\n    diveDeep(prop) {\r\n        const res = super.get(prop);\r\n        if (res !== undefined && this.testValue(res, 'object')) {\r\n            return new ApiParams(res);\r\n        }\r\n        throw_fm_panic(400, `\"${prop}\" not found.`);\r\n    }\r\n    // parseProduct<P extends KeyOfFilterType<T, ProductConfig>>(prop: P): ProductDescriptor\r\n    // parseProduct<P extends KeyOfFilterType<T, ProductConfig>>(prop: P, maybe: true): ProductDescriptor | undefined\r\n    // parseProduct<P extends KeyOfFilterType<T, ProductConfig>>(prop: P, maybe?: true): ProductDescriptor | undefined {\r\n    //     const res = super.get(prop)\r\n    //     if (res !== undefined && this.testValue(res, 'object')) {\r\n    //         return new ProductDescriptor(res)\r\n    //     }\r\n    //     if (!maybe) {\r\n    //         throw_fm_panic(400, `\"${prop}\" not found.`)\r\n    //     } else {\r\n    //         return undefined\r\n    //     }\r\n    // }\r\n    doIfAny(prop, match, then) {\r\n        const res = super.get(prop);\r\n        if (res === undefined) {\r\n            return;\r\n        }\r\n        if (this.any(res, match)) {\r\n            then === null || then === void 0 ? void 0 : then(res);\r\n        }\r\n    }\r\n    doIfAll(prop, match, then) {\r\n        const res = super.get(prop);\r\n        if (res === undefined) {\r\n            return;\r\n        }\r\n        if (this.all(res, match)) {\r\n            then === null || then === void 0 ? void 0 : then(res);\r\n        }\r\n    }\r\n    doIf(prop, match, then) {\r\n        const res = super.get(prop);\r\n        if (res === undefined) {\r\n            return;\r\n        }\r\n        if (this.testValue(res, match)) {\r\n            then === null || then === void 0 ? void 0 : then(res);\r\n        }\r\n    }\r\n}\r\nexport function testApiParams(cs, params) {\r\n    // Usage:\r\n    params.ensure('str', 'string');\r\n    params.ensureAny('str', ['string', 'number']);\r\n    params.ensureAll('str', ['string', 'number']);\r\n    params.getIf('str', 'string');\r\n    params.getIf('str', 'string', 'foo');\r\n    params.getIfAny('str', ['string', 'number']);\r\n    params.getIfAny('str', ['string', 'number'], 'foo');\r\n    params.getIfAll('str', ['string', 'number']);\r\n    params.getIfAll('str', ['string', 'number'], 'foo');\r\n    // params.parseProduct('product')\r\n    // params.parseProduct('product', true)\r\n    params.diveDeepOrUndefined('obj');\r\n    params.diveDeep('obj');\r\n    params.doIf('str', 'string', str => console.log(str));\r\n    params.doIfAny('str', ['string', 'number'], str => console.log(str));\r\n    params.doIfAll('str', ['string', 'number'], str => console.log(str));\r\n}\r\n//# sourceMappingURL=params.js.map","references":["/Users/caojiahang/代码/tora/src/error.ts","/Users/caojiahang/代码/tora/src/type.ts","/Users/caojiahang/代码/tora/src/server/context.ts"],"map":"{\"version\":3,\"file\":\"params.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../src/server/params.ts\"],\"names\":[],\"mappings\":\"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\"}"}
